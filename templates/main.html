<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reverse Image Filtering</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles.css') }}" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet" />
  </head>
  <body>
    <!-- Breadcrumb -->
    <div class="breadcrumb-container">
      <div class="breadcrumb-content">
        <h2>Reverse Image Filtering</h2>
        <p>
          <span>Home</span> &bull; <span>Reverse Image Filtering</span>
          <span id="breadcrumb-process" class="hidden"
            >&bull; <span>Process</span></span
          >
        </p>
      </div>
      <div class="breadcrumb-icon">
        <img
          src="{{ url_for('static', filename='images/icons.png') }}"
          alt="Icon" />
      </div>
    </div>

    <!-- Upload & Preview Section -->
    <div id="uploadSection" class="upload-container">
      <div>
        <label
          for="originalUpload"
          class="upload-button"
          id="originalUploadLabel"
          >Upload <b>Original</b> Image</label
        >
        <input type="file" id="originalUpload" accept="image/*" hidden />
        <span id="originalPreview"></span>
      </div>
      <div style="margin-top: 16px">
        <label
          for="filteredUpload"
          class="upload-button"
          id="filteredUploadLabel"
          >Upload <b>Filtered</b> Image</label
        >
        <input type="file" id="filteredUpload" accept="image/*" hidden />
        <span id="filteredPreview"></span>
      </div>

      <button
        id="processButton"
        class="process-button"
        style="display: none; margin-top: 24px">
        Remove Filter
      </button>
    </div>

    <!-- Process/Results Section -->
    <div id="processSection" class="process-container hidden">
      <div style="display: flex; gap: 20px; justify-content: flex-start">
        <div class="image-container">
          <h3>Original Image</h3>
          <div id="originalImage" class="image-box"></div>
        </div>
        <div class="image-container">
          <h3>Filtered Image</h3>
          <div id="filteredImage" class="image-box"></div>
        </div>
        <div class="image-container">
          <h3>Restored Image (Defilter)</h3>
          <div id="restoredImage" class="image-box"></div>
        </div>
      </div>
      <div class="similarity-row" style="margin-top: 24px">
        <span class="similarity-label">Similarity : </span>
        <div class="similarity-bar-container">
          <div id="similarityBar" class="similarity-fill"></div>
        </div>
        <span id="similarityScore" class="similarity-percentage">0%</span>
      </div>
      <div id="loadingIndicator" class="loading-indicator hidden">
        <div class="loader"></div>
        <p>Processing... This may take a few moments</p>
      </div>
    </div>

    <!-- Back Button -->
    <div class="back-container hidden" id="backContainer">
      <a href="#" class="back-button" id="backToUpload">← Back to Upload</a>
    </div>

    <script>
      // Elements
      const originalUpload = document.getElementById("originalUpload");
      const filteredUpload = document.getElementById("filteredUpload");
      const originalPreview = document.getElementById("originalPreview");
      const filteredPreview = document.getElementById("filteredPreview");
      const processButton = document.getElementById("processButton");
      const uploadSection = document.getElementById("uploadSection");
      const processSection = document.getElementById("processSection");
      const originalImage = document.getElementById("originalImage");
      const filteredImage = document.getElementById("filteredImage");
      const restoredImage = document.getElementById("restoredImage");
      const similarityBar = document.getElementById("similarityBar");
      const similarityScore = document.getElementById("similarityScore");
      const backContainer = document.getElementById("backContainer");
      const backToUpload = document.getElementById("backToUpload");
      const breadcrumbProcess = document.getElementById("breadcrumb-process");
      const loadingIndicator = document.getElementById("loadingIndicator");

      let originalFile = null,
        filteredFile = null;
      let originalImageData = null,
        filteredImageData = null;

      window.addEventListener("DOMContentLoaded", function () {
        // 检查URL参数
        const params = new URLSearchParams(window.location.search);
        const filteredUrl = params.get("filtered");
        if (filteredUrl) {
          // 自动填充Filtered区域，并禁用上传按钮
          filteredImageData = decodeURIComponent(filteredUrl);
          filteredImage.innerHTML = `<img src="${filteredImageData}" alt="Filtered Image" />`;
          filteredPreview.innerHTML = `<img src="${filteredImageData}" alt="Filtered Image" class="upload-preview-img">`;
          // 隐藏Filtered Upload按钮
          document.getElementById("filteredUploadLabel").style.display = "none";
          document.getElementById("filteredUpload").style.display = "none";
          enableProcessBtn();
        }
      });

      // Upload preview for both
      originalUpload.addEventListener("change", function (event) {
        const file = event.target.files[0];
        if (file) {
          originalFile = file;
          const reader = new FileReader();
          reader.onload = function (e) {
            originalImageData = e.target.result;
            originalPreview.innerHTML = `<img src="${originalImageData}" alt="Original Image" class="upload-preview-img">`;
            originalImage.innerHTML = `<img src="${originalImageData}" alt="Original Image" />`;
            enableProcessBtn();
          };
          reader.readAsDataURL(file);
        }
      });

      filteredUpload.addEventListener("change", function (event) {
        const file = event.target.files[0];
        if (file) {
          filteredFile = file;
          const reader = new FileReader();
          reader.onload = function (e) {
            filteredImageData = e.target.result;
            filteredPreview.innerHTML = `<img src="${filteredImageData}" alt="Filtered Image" class="upload-preview-img">`;
            filteredImage.innerHTML = `<img src="${filteredImageData}" alt="Filtered Image" />`;
            enableProcessBtn();
          };
          reader.readAsDataURL(file);
        }
      });

      function enableProcessBtn() {
        // Enable only if both are uploaded
        if (originalFile && filteredFile) {
          processButton.style.display = "block";
        }
      }

      // Main process button
      processButton.addEventListener("click", function () {
        if (!originalFile || (!filteredFile && !filteredImageData)) return;
        loadingIndicator.classList.remove("hidden");
        processButton.disabled = true;

        // Hide upload, show process/results UI
        uploadSection.classList.add("hidden");
        processSection.classList.remove("hidden");
        backContainer.classList.remove("hidden");
        breadcrumbProcess.classList.remove("hidden");

        // Show selected images in result area
        originalImage.innerHTML = `<img src="${originalImageData}" alt="Original Image" />`;
        filteredImage.innerHTML = `<img src="${filteredImageData}" alt="Filtered Image" />`;

        // Prepare the image for upload
        const formData = new FormData();
        formData.append("original", originalFile);
        if (
          !filteredFile &&
          filteredImageData &&
          filteredImageData.startsWith("http")
        ) {
          formData.append("filtered_url", filteredImageData);
        } else if (filteredFile) {
          formData.append("filtered", filteredFile);
        }

        fetch("/process", { method: "POST", body: formData })
          .then((response) => response.json())
          .then((data) => {
            loadingIndicator.classList.add("hidden");
            restoredImage.innerHTML = `<img src="${data.restored}" alt="Restored Image" />`;
            const similarity = data.similarity || 0;
            similarityBar.style.width = similarity + "%";
            similarityScore.textContent = similarity + "%";
            similarityBar.classList.remove("high", "medium", "low");
            if (similarity >= 75) similarityBar.classList.add("high");
            else if (similarity >= 35) similarityBar.classList.add("medium");
            else similarityBar.classList.add("low");
            processButton.disabled = false;
          })
          .catch((error) => {
            loadingIndicator.classList.add("hidden");
            alert("Failed to process image: " + error);
            processButton.disabled = false;
          });
      });

      // Back to Upload Section
      backToUpload.addEventListener("click", function (e) {
        e.preventDefault();
        uploadSection.classList.remove("hidden");
        processSection.classList.add("hidden");
        backContainer.classList.add("hidden");
        breadcrumbProcess.classList.add("hidden");
        originalUpload.value = "";
        filteredUpload.value = "";
        originalPreview.innerHTML = "";
        filteredPreview.innerHTML = "";
        originalImage.innerHTML = "";
        filteredImage.innerHTML = "";
        restoredImage.innerHTML = "";
        similarityBar.style.width = "0%";
        similarityScore.textContent = "0%";
        processButton.style.display = "none";
        originalFile = filteredFile = null;
        originalImageData = filteredImageData = null;
      });
    </script>
  </body>
</html>
